name: Deploy Esp2Ru_bot to Server

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          echo "üöß –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –ø—Ä–æ–µ–∫—Ç"
          cd /root
          if [ -d Esp2Rus_bot ]; then
            cd Esp2Rus_bot
            docker compose down
            cd ..
            rm -rf Esp2Rus_bot
            echo "üßπ –°—Ç–∞—Ä—ã–π –ø—Ä–æ–µ–∫—Ç —É–¥–∞–ª—ë–Ω"
          else
            echo "‚ö†Ô∏è –ö–∞—Ç–∞–ª–æ–≥ Esp2Rus_bot –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ."
          fi

          echo "üì¶ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∑–∞–Ω–æ–≤–æ"
          git clone --depth=1 https://github.com/Nikolay08041979/Esp2Rus_bot.git
          cd Esp2Rus_bot
          
          echo "üìÑ –°–æ–∑–¥–∞—ë–º .env —Ñ–∞–π–ª"
          cp .env.example .env
          echo "‚ö†Ô∏è –ù–µ –∑–∞–±—É–¥—å –≤—Ä—É—á–Ω—É—é –æ–±–Ω–æ–≤–∏—Ç—å .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º!"

          echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç"
          docker compose up -d --build
          
          echo "üîÅ –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—ã –∏ –º–µ—Ç—Ä–∏–∫–∏"
          docker compose exec esp2ru_app python run_install.py --sync

          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ"

