name: Deploy Esp2Ru_bot to Server

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22

        envs: DB_PASSWORD,BOT_TOKEN_PROD,ADMIN_IDS

        script: |
          echo "üöß –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –ø—Ä–æ–µ–∫—Ç"
          cd /root
          if [ -d Esp2Rus_bot ]; then
            cd Esp2Rus_bot
            docker compose down
            cd ..
            rm -rf Esp2Rus_bot
            echo "üßπ –°—Ç–∞—Ä—ã–π –ø—Ä–æ–µ–∫—Ç —É–¥–∞–ª—ë–Ω"
          else
            echo "‚ö†Ô∏è –ö–∞—Ç–∞–ª–æ–≥ Esp2Rus_bot –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ."
          fi

          echo "üì¶ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∑–∞–Ω–æ–≤–æ"
          git clone --depth=1 https://github.com/Nikolay08041979/Esp2Rus_bot.git
          cd Esp2Rus_bot
          
          echo "üß© –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º .env –∏–∑ secrets"
          bash generate_env.sh
          
          echo "üíæ –î–µ–ª–∞–µ–º –±—ç–∫–∞–ø –ø—Ä–æ–¥-—Ç–∞–±–ª–∏—Ü"
          bash backup_before_deploy.sh
          
          echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç"
          docker compose up -d --build
          
          echo "üîÅ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ø–µ—Ä–µ—Å—á—ë—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏"
          docker compose exec esp2rus_bot python run_install.py --sync
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ"

