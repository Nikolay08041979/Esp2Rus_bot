
# üìä Esp2Rus_bot ‚Äî –§–∏–Ω–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ v2

## ‚úÖ –¶–µ–ª—å
–ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ v2 –∑–∞–º–µ–Ω—è–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Å—Ç–µ–∫ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- –ß–∏—Å—Ç—É—é –º–æ–¥—É–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
- –†–∞—Å—á—ë—Ç –º–µ—Ç—Ä–∏–∫: quiz_weight, client_rating
- –ù–∞–¥—ë–∂–Ω—É—é –∑–∞–ø–∏—Å—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –£–ø—Ä–æ—â—ë–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–∫–∞—Ç

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
analytics/
‚îú‚îÄ‚îÄ analytics.py                    # orchestration layer
‚îú‚îÄ‚îÄ save_client_activity_log.py     # –∑–∞–ø–∏—Å—å client_activity_log
‚îú‚îÄ‚îÄ save_client_analytics.py        # —Ä–∞—Å—á—ë—Ç client_rating
‚îú‚îÄ‚îÄ metrics/
‚îÇ   ‚îú‚îÄ‚îÄ calculate_quiz_weight.py    # —Ñ–æ—Ä–º—É–ª–∞ –∏ fetch
‚îÇ   ‚îú‚îÄ‚îÄ calculate_client_rating.py
‚îÇ   ‚îú‚îÄ‚îÄ get_level_id_word.py
‚îÇ   ‚îî‚îÄ‚îÄ ...
```

---

## üìê –ú–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞           | –û–ø–∏—Å–∞–Ω–∏–µ                                      |
|-------------------|-----------------------------------------------|
| `quiz_weight`     | –°—Ä–µ–¥–Ω–∏–π –≤–µ—Å —Å–ª–æ–≤ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã —á–µ—Ä–µ–∑ view         |
| `client_rating`   | –°—É–º–º–∞ `quiz_weight` –≤—Å–µ—Ö 100% —Å–µ—Å—Å–∏–π          |
| `level_id_word`   | –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–≤ ‚Äî –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `study_levels`      |
| `level_id_current`| ‚ùå –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω, –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω               |

---

## üß™ –†–∞–±–æ—Ç–∞ –ª–æ–≥–∏–∫–∏

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤–∏–∫—Ç–æ—Ä–∏–Ω—É
2. `analytics.py` –≤—ã–∑—ã–≤–∞–µ—Ç:
   - `save_client_activity_log(data)`
   - `save_client_analytics(client_id)`
3. –í –ª–æ–≥ (`data/logs/analytics_debug/quiz_weight_v2.log`) –ø–∏—à–µ—Ç—Å—è:
```
2025-05-09 18:40:55: client_id=1, quiz_weight=1.1, client_rating=62.43
```
4. –ó–∞–ø–∏—Å—å —Ç–∞–∫–∂–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `cron_events`

---

## üîÅ –û—Ç–∫–∞—Ç

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
```
python tools/rollback_analytics.py
```

–î–µ–π—Å—Ç–≤–∏—è:
- –ú–µ–Ω—è–µ—Ç —Ñ–ª–∞–≥ `USE_ANALYTICS_V2 = False`
- –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `analytics.py` –∏–∑ `analytics_old/analytics_v1_backup.py`

---

## üßæ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

| –ò—Å—Ç–æ—á–Ω–∏–∫               | –ü—É—Ç—å/—Ç–∞–±–ª–∏—Ü–∞                                |
|------------------------|----------------------------------------------|
| –°–µ—Å—Å–∏–∏                 | `data/logs/analytics_debug/quiz_weight_v2.log` |
| –û—à–∏–±–∫–∏/—Å–æ–±—ã—Ç–∏—è cron    | —Ç–∞–±–ª–∏—Ü–∞ `cron_events` –≤ PostgreSQL           |

---

## üõ° –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å

- –í—Å—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (asyncpg)
- –£—Å—Ç–æ–π—á–∏–≤–æ –∫ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—é –¥–∞–Ω–Ω—ã—Ö (fallback = None)
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç rollback –∏ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üß≠ –í –ø–ª–∞–Ω–∞—Ö

- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏ `level_id_current`
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ `/my_stats` –≤ Telegram
- CI/CD + pytest –¥–ª—è –º–µ—Ç—Ä–∏–∫
