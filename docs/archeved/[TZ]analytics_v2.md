# üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ Esp2Rus_bot (v2)

## üéØ –¶–µ–ª—å:
–°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–≥–æ, –º–æ–¥—É–ª—å–Ω–æ–≥–æ –∏ —É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å—Ç–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç:
- –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Telegram-–±–æ—Ç–∞
- —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (`quiz_weight`, `client_rating`)
- —Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –æ–±—É—á–µ–Ω–∏—è
- –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
analytics/
‚îú‚îÄ‚îÄ analytics.py                         # orchestration layer
‚îú‚îÄ‚îÄ save_client_activity_log.py          # –∑–∞–ø–∏—Å—å client_activity_log + client_activity_words
‚îú‚îÄ‚îÄ save_client_analytics.py             # —Ä–∞—Å—á—ë—Ç client_rating + —É—Ä–æ–≤–µ–Ω—å
‚îú‚îÄ‚îÄ rollback_analytics.py                # –æ—Ç–∫–∞—Ç
‚îú‚îÄ‚îÄ personalization/
‚îÇ   ‚îú‚îÄ‚îÄ update_learned_words.py
‚îÇ   ‚îú‚îÄ‚îÄ update_user_progress_by_theme.py
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ reports/
‚îÇ   ‚îú‚îÄ‚îÄ report_user.py                   # /report @user
‚îÇ   ‚îú‚îÄ‚îÄ summary_cron.py                  # cron-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ forms/
‚îÇ       ‚îú‚îÄ‚îÄ csv_template_user_report.csv
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ metrics/
‚îÇ   ‚îú‚îÄ‚îÄ calculate_quiz_weight.py
‚îÇ   ‚îú‚îÄ‚îÄ calculate_client_rating.py
‚îÇ   ‚îú‚îÄ‚îÄ get_level_id_word.py
‚îÇ   ‚îú‚îÄ‚îÄ calculate_level_current.py
‚îÇ   ‚îî‚îÄ‚îÄ ...
```

---

## üìê –ú–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞           | –ò—Å—Ç–æ—á–Ω–∏–∫/–õ–æ–≥–∏–∫–∞                                     |
|-------------------|-----------------------------------------------------|
| `quiz_weight`     | –°—Ä–µ–¥–Ω–∏–π –≤–µ—Å —Å–ª–æ–≤ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã —á–µ—Ä–µ–∑ `view_word_weight` |
| `client_rating`   | –°—É–º–º–∞ `quiz_weight` –≤—Å–µ—Ö —É—Å–ø–µ—à–Ω—ã—Ö —Å–µ—Å—Å–∏–π            |
| `level_id_word`   | –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–≤ ‚Äî `get_level_id_word()`                |
| `level_id_current`| –ü–æ–∫—Ä—ã—Ç–∏–µ + —Ç–æ—á–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ `calculate_level_current`|

---

## üîÅ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

- `data/logs/analytics_debug/*.log`
- `cron_events` (PostgreSQL) ‚Äî —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–¥–∞—á–∏

---

## ‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

- `USE_ANALYTICS_V2 = True` ‚Äî –≤–∫–ª—é—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—Ç–µ–∫–∞
- `DELETE_INACTIVE_CLIENTS = False` ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞
- `LEVEL_CALCULATION_ONLINE = True` ‚Äî —Ä–∞—Å—á–µ—Ç —É—Ä–æ–≤–Ω—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã
- `rollback_analytics.py` ‚Äî –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ + –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ `analytics_v1`

---

## üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

| –¢–∞–±–ª–∏—Ü–∞                     | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                              |
|-----------------------------|----------------------------------------------------------|
| `client_info`               | –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é                      |
| `client_activity_log`       | –õ–æ–≥ —Å–µ—Å—Å–∏–π –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã                                    |
| `client_activity_words`     | –°–ª–æ–≤–∞, –≤—Ö–æ–¥–∏–≤—à–∏–µ –≤ —Å–µ—Å—Å–∏—é                               |
| `client_analytics`          | –ü—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (rating, level, score_total –∏ —Ç.–ø.) |
| `learned_words`             | –í—ã—É—á–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ (‚â•3 —É—Å–ø–µ—à–Ω—ã—Ö –ø–æ–≤—Ç–æ—Ä–æ–≤)                 |
| `user_word_stats`           | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–∂–¥–æ–º—É —Å–ª–æ–≤—É (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)              |
| `user_progress_by_theme`    | –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–µ–º–∞–º –∏ —É—Ä–æ–≤–Ω—è–º (–¥–ª—è UI –∏ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏)       |
| `study_levels`              | CEFR-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Ä–æ–≤–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏                        |
| `level_matrix`              | –ú–∞—Ç—Ä–∏—Ü–∞ —É—Å–ª–æ–≤–∏–π –ø–µ—Ä–µ—Ö–æ–¥–∞ –º–µ–∂–¥—É —É—Ä–æ–≤–Ω—è–º–∏                 |

---

## üìÜ –≠—Ç–∞–ø—ã —Ä–µ–ª–∏–∑–∞

### –≠—Ç–∞–ø 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ ‚Äî ‚úÖ
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –∏ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö
- –°–∫—Ä–∏–ø—Ç—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è, —Ä–∞—Å—á—ë—Ç–∞ –º–µ—Ç—Ä–∏–∫

### –≠—Ç–∞–ø 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Telegram-–±–æ—Ç ‚Äî ‚úÖ
- asyncpg
- —Å–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ quiz
- –∑–∞–ø–∏—Å—å client_info, client_analytics

### –≠—Ç–∞–ø 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ—Ç–ª–∞–¥–∫–∞ ‚Äî ‚úÖ
- –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã
- —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–æ—à–ª–æ–π –≤–µ—Ä—Å–∏–µ–π
- –ø—Ä–æ–≤–µ—Ä–∫–∞ quiz_weight, learned_words, rating

### –≠—Ç–∞–ø 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–∫–∞—Ç ‚Äî ‚úÖ
- rollback_analytics.py
- cron_events
- config-—Ñ–ª–∞–≥–∏

---

## üîú –°–ª–µ–¥—É—é—â–∏–µ —ç—Ç–∞–ø—ã:

### –≠—Ç–∞–ø 5. –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî üü°
- `user_progress_by_theme` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω–µ
- `user_word_stats` ‚Äî —Ä–∞—Å—á—ë—Ç –∏–ª–∏ –∞—Ä—Ö–∏–≤
- `client_level_progress` ‚Äî –≥–æ—Ç–æ–≤ –∫–∞–∫ VIEW

### –≠—Ç–∞–ø 6. –ü–∞–Ω–µ–ª—å –∏ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å ‚Äî üü°
- `/admin_clients`
- `/report @user`
- `analytics/reports/report_user.py`

### –≠—Ç–∞–ø 7. Cron-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî üîú
- `summary_cron.py`: –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –¥–∏–Ω–∞–º–∏–∫–∞, —Ä–µ–π—Ç–∏–Ω–≥

### –≠—Ç–∞–ø 8. –ú–∏–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ–¥ ‚Äî üîú
- `run_install.py`
- `README_Prod_Migration.md`
- –∞–≤—Ç–æ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ VIEW –∏ —Ç–∞–±–ª–∏—Ü