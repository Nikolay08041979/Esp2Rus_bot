## Bug Fixes Plan (ветка: `fix-bugs`)

### Цель:
Обеспечить корректную работу Telegram-бота Español_bot как в пользовательском, так и в админском режимах, а также улучшить UX и устойчивость к типичным ошибкам ввода.

---

### 1. Баг: `/start` не переходит к выбору уровня
- **Описание:** После выбора категории бот повторно запрашивает категорию, вместо перехода на уровень.
- **Решение:**
  - Проверить, корректно ли отрабатывает `state.set(CategorySelected)` и `state.set(LevelSelected)`
  - Убедиться, что состояние очищается или переключается после обработки категории
  - Добавить логирование или дебаг-ответы для отслеживания FSM

---

### 2. Баг: `/admin` статистика — отсутствие переноса строки после заголовка
- **Описание:** Первая строка сливается с заголовком (UX-проблема)
- **Решение:**
  - Добавить `\n\n` после заголовков в методах `show_stats` и `show_level_stats`

---

### 3. Баг: Добавление категории — бот молчит
- **Описание:** При вводе новой категории после `/admin -> Добавить категорию` — отсутствует реакция
- **Решение:**
  - Проверить правильность `@router.message(StateFilter(...))`
  - Убедиться, что декоратор не перекрывается другими `@router.message(F.text)`
  - Добавить `await message.answer()` с подтверждением добавления

---

### 4. Баг: Удаление категории — не реагирует
- **Описание:** При вводе названия для удаления — нет действия
- **Решение:**
  - Приводить имя категории к нижнему регистру: `name.strip().lower()`
  - Аналогично — искать совпадения по `LOWER(cat_name)`

---

### 5. Баг: Добавление и удаление уровня — аналогично категориям
- **Описание:** FSM не срабатывает, нет подтверждений
- **Решение:**
  - Внести аналогичные правки как в категории
  - Нормализовать входной текст (регистр, пробелы)

---

### Дополнительные улучшения (UX / стабильность):
- [x] Добавить поддержку `/cancel` вне зависимости от состояния
- [x] Очистка состояния через `await state.clear()`
- [x] Отправка сообщения с переходом к `/start`
- [x] Переместить `@router.message(F.document)` выше `@router.message(F.text)`
- [ ] Добавить логи ошибок (например, логгировать в файл `errors.log`)
- [ ] Реализовать глобальный exception handler для Telegram API

---

### Ветка:
- Название: `fix-bugs`
- Основана от: `main`
- Назначение: Внести правки, связанные с устранением багов и улучшением надежности FSM

---

### Комментарии:
- Все user-input сравнения делаем в `.lower()`
- FSM не должен конфликтовать между админ-панелью и пользователями
- В приоритете: стабильная загрузка CSV и реакция на команды `/start`, `/cancel`, `/admin`

---

### После завершения:
- Тестирование с разными сценариями (сброс, переключение, загрузка CSV)
- Слияние ветки `fix-bugs` в `main`
- Обновление документации (README + DOC/deploy.md + DOC/bugs.md)
- Создание релиза `v1.0.1`

---

### Важное:
Все обсуждения по этой теме вынесены в ветку `fix-bugs` для сохранения преемственности, чтобы не потерялась логика исправлений.

